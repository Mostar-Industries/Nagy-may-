version: '3.8'

services:
  # PostgreSQL Database - Shared across all services
  postgres:
    image: postgres:16-alpine
    container_name: skyhawk-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mastomys}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-skyhawk_dev_2024}
      POSTGRES_DB: ${POSTGRES_DATABASE:-mastomys_tracker}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mastomys}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - skyhawk-network

  # ML Service - YOLO inference + Risk scoring
  ml-service:
    build:
      context: ./ml_service
      dockerfile: Dockerfile
    container_name: skyhawk-ml-service
    environment:
      FLASK_ENV: ${FLASK_ENV:-development}
      DATABASE_URL: postgresql://${POSTGRES_USER:-mastomys}:${POSTGRES_PASSWORD:-skyhawk_dev_2024}@postgres:5432/${POSTGRES_DATABASE:-mastomys_tracker}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "5001:5000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./ml_service:/app
      - ml_models:/app/models
    networks:
      - skyhawk-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # REST API - Detection endpoints, YOLO inference API
  api-service:
    build:
      context: ./MNTRK_API
      dockerfile: Dockerfile
    container_name: skyhawk-api-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-mastomys}:${POSTGRES_PASSWORD:-skyhawk_dev_2024}@postgres:5432/${POSTGRES_DATABASE:-mastomys_tracker}
      YOLO_SERVICE_URL: http://ml-service:5000
      FLASK_ENV: ${FLASK_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "5002:8080"
    depends_on:
      postgres:
        condition: service_healthy
      ml-service:
        condition: service_healthy
    volumes:
      - ./MNTRK_API:/app
      - api_uploads:/app/uploads
    networks:
      - skyhawk-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ui/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Agent API - LLM-powered query interface
  agent-service:
    build:
      context: ./MNTRK_Agent_API
      dockerfile: Dockerfile
    container_name: skyhawk-agent-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-mastomys}:${POSTGRES_PASSWORD:-skyhawk_dev_2024}@postgres:5432/${POSTGRES_DATABASE:-mastomys_tracker}
      API_SERVICE_URL: http://api-service:8080
      ML_SERVICE_URL: http://ml-service:5000
      GEMINI_API_KEY: ${GEMINI_API_KEY:-your-key-here}
      FLASK_ENV: ${FLASK_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "5003:8080"
    depends_on:
      postgres:
        condition: service_healthy
      api-service:
        condition: service_healthy
    volumes:
      - ./MNTRK_Agent_API:/app
    networks:
      - skyhawk-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ui/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Capture Service - Automated RTSP frame capture and inference
  capture-service:
    build:
      context: ./capture_service
      dockerfile: Dockerfile
    container_name: skyhawk-capture-service
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-mastomys}:${POSTGRES_PASSWORD:-skyhawk_dev_2024}@postgres:5432/${POSTGRES_DATABASE:-mastomys_tracker}
      YOLO_API_URL: http://ml-service:5000
      SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
      SUPABASE_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      INFERENCE_INTERVAL: ${INFERENCE_INTERVAL:-5}
      MOTION_THRESHOLD: ${MOTION_THRESHOLD:-0.1}
      MIN_CONFIDENCE: ${MIN_CONFIDENCE:-0.5}
      ENABLE_SNAPSHOTS: ${ENABLE_SNAPSHOTS:-true}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    depends_on:
      postgres:
        condition: service_healthy
      ml-service:
        condition: service_healthy
    volumes:
      - ./capture_service:/app
      - capture_snapshots:/tmp/snapshots
    networks:
      - skyhawk-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  ml_models:
    driver: local
  api_uploads:
    driver: local
  capture_snapshots:
    driver: local

networks:
  skyhawk-network:
    driver: bridge
